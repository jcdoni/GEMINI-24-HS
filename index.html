<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini TV v7.0 | Enterprise Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        
        :root {
            --fire-blue: #00a8e1;
            --fire-dark: #0f171e;
            --fire-card: #1a242f;
            --text-main: #ffffff;
            --border: rgba(255, 255, 255, 0.08);
            --bg-sidebar: #131a22;
        }

        .light-mode {
            --fire-dark: #f0f2f5;
            --fire-card: #ffffff;
            --text-main: #1a242f;
            --border: rgba(0, 0, 0, 0.1);
            --bg-sidebar: #e1e4e8;
        }

        /* Layout Estrutural (Flexbox Matemático para Scroll Perfeito) */
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--fire-dark); 
            color: var(--text-main); 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; /* O body não rola, quem rola são os painéis */
            display: flex;
            flex-direction: column;
        }

        .glass-nav { 
            height: 80px; 
            flex-shrink: 0; 
            background: rgba(15, 23, 30, 0.98); 
            border-bottom: 1px solid var(--border); 
            display: flex;
            align-items: center;
            padding: 0 2rem;
            z-index: 50;
        }

        /* Container Principal */
        #main-view {
            flex: 1; /* Ocupa todo o espaço restante (100vh - 80px) */
            position: relative;
            overflow: hidden; 
        }

        /* Sections que rolam (Home, Playlists) */
        .scrollable-page {
            height: 100%;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Layout Dual Pane (Editor & Theater) - Sem Scroll na Página, só nas listas */
        .split-view {
            display: grid; 
            grid-template-columns: 320px 1fr; 
            height: 100%; 
        }

        .col-sidebar {
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .col-content {
            background: var(--fire-dark);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* O Segredo da Rolagem: Flex-1 + Overflow Auto */
        .list-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-bottom: 20px; /* Espaço extra no fim */
        }

        /* Scrollbar Estilizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--fire-blue); }

        /* Theater Mode */
        .video-wrapper {
            background: black;
            height: 55%; /* Altura fixa pro vídeo */
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        video { width: 100%; height: 100%; object-fit: contain; }

        .theater-channels {
            height: 45%; /* Resto pra grade */
            overflow-y: auto;
            background: var(--fire-dark);
            padding: 1rem;
        }

        .channel-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .channel-card {
            background: var(--fire-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .channel-card:hover { border-color: var(--fire-blue); transform: translateY(-2px); }
        .channel-card img { width: 40px; height: 40px; object-fit: contain; margin: 0 auto 8px; }

        /* Toolbar de Busca */
        .search-bar {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        .search-input {
            width: 100%;
            background: var(--fire-card);
            border: 1px solid var(--border);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            outline: none;
        }
        .search-input:focus { border-color: var(--fire-blue); }

        /* Linhas do Editor */
        .item-row {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
        }
        .item-row:hover { background: rgba(255,255,255,0.05); }
        .item-row.active { background: var(--fire-blue); color: white; }
        .item-row.hidden-item { opacity: 0.5; filter: grayscale(1); }
        
        .row-actions { margin-left: auto; display: flex; gap: 10px; opacity: 0; transition: 0.2s; }
        .item-row:hover .row-actions { opacity: 1; }
        .row-actions i { 
            padding: 6px; 
            border-radius: 4px; 
            background: rgba(0,0,0,0.3); 
            font-size: 12px;
        }
        .row-actions i:hover { background: var(--fire-blue); color: white; }

        /* Tabela Playlists */
        .pl-table { width: 100%; border-collapse: collapse; }
        .pl-table th { text-align: left; padding: 15px; border-bottom: 2px solid var(--border); color: var(--fire-blue); font-size: 11px; text-transform: uppercase; }
        .pl-table td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 13px; }

        /* UI Helpers */
        .btn-primary { background: var(--fire-blue); color: white; font-weight: bold; padding: 8px 16px; border-radius: 6px; font-size: 12px; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: #0090c0; }
        
        .active-nav { color: var(--fire-blue); border-bottom: 3px solid var(--fire-blue); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--fire-card); padding: 30px; border-radius: 16px; width: 400px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--fire-card); border-left: 4px solid var(--fire-blue); padding: 15px 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: bold; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <nav class="glass-nav">
        <div class="flex items-center gap-8 w-full">
            <div class="text-2xl font-bold tracking-tighter text-white cursor-pointer" onclick="App.nav('home')">
                GEMINI<span class="text-cyan-500">TV</span> <span class="text-[9px] text-gray-500 ml-1 border border-gray-600 px-1 rounded">ENT V7.0</span>
            </div>
            
            <div class="flex h-full items-end gap-6 text-[11px] font-bold text-gray-400 uppercase tracking-widest pb-6">
                <span id="nav-home" class="cursor-pointer hover:text-white transition-all pb-1 active-nav" onclick="App.nav('home')">Início</span>
                <span id="nav-playlists" class="cursor-pointer hover:text-white transition-all pb-1" onclick="App.nav('playlists')">Playlists</span>
                <span id="nav-editor" class="cursor-pointer hover:text-white transition-all pb-1" onclick="App.nav('editor')">Editor</span>
                <span id="nav-channels" class="cursor-pointer hover:text-white transition-all pb-1" onclick="App.nav('editor')">Canais</span>
                <span id="nav-logos" class="cursor-pointer hover:text-white transition-all pb-1">Logos</span>
                <span id="nav-epgs" class="cursor-pointer hover:text-white transition-all pb-1">EPGs</span>
            </div>

            <div class="ml-auto flex items-center gap-4">
                <button onclick="App.importUI()" class="text-gray-300 hover:text-white text-[10px] font-bold uppercase flex items-center gap-2 border border-white/10 px-3 py-1.5 rounded hover:bg-white/5">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Importar
                </button>
                <div id="user-display" class="flex items-center gap-3">
                    <button onclick="UI.toggleModal('modal-login', true)" class="btn-primary">Entrar</button>
                </div>
            </div>
        </div>
    </nav>

    <div id="main-view">
        
        <section id="page-home" class="scrollable-page">
            <div class="grid grid-cols-2 gap-6 mb-8 h-48">
                <div onclick="App.nav('theater')" class="relative bg-gradient-to-br from-blue-900 to-cyan-900 rounded-xl p-8 cursor-pointer hover:scale-[1.01] transition-all flex flex-col justify-center overflow-hidden shadow-2xl group">
                    <h2 class="text-3xl font-bold text-white z-10">Theater Mode</h2>
                    <p class="text-cyan-200 text-sm z-10">Player HLS Profissional</p>
                    <i class="fa-solid fa-tv text-9xl absolute -right-6 -bottom-6 text-white/10 group-hover:text-white/20 transition-all"></i>
                </div>
                <div class="relative bg-gradient-to-br from-purple-900 to-pink-900 rounded-xl p-8 cursor-pointer flex flex-col justify-center overflow-hidden shadow-2xl opacity-80">
                    <h2 class="text-3xl font-bold text-white z-10">VOD & Filmes</h2>
                    <p class="text-purple-200 text-sm z-10">Em Breve</p>
                    <i class="fa-solid fa-film text-9xl absolute -right-6 -bottom-6 text-white/10"></i>
                </div>
            </div>
            
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 border-b border-white/10 pb-2">Suas Playlists Salvas (IndexedDB)</h3>
            <div id="home-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                </div>
        </section>

        <section id="page-playlists" class="scrollable-page hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Gerenciador de Bases</h2>
                <button onclick="App.importUI()" class="btn-primary">+ Nova Lista</button>
            </div>
            <table class="pl-table">
                <thead>
                    <tr><th>Nome</th><th>Origem</th><th>Grupos</th><th>Canais</th><th>Ações</th></tr>
                </thead>
                <tbody id="pl-body"></tbody>
            </table>
        </section>

        <section id="page-editor" class="split-view hidden">
            <div class="col-sidebar">
                <div class="p-3 border-b border-white/10 bg-[#151f28]">
                    <select id="editor-pl-select" onchange="Editor.switchPL(this.value)" class="w-full bg-black/30 text-xs text-white p-2 rounded border border-white/10 outline-none mb-2"></select>
                    <input type="text" id="search-groups" placeholder="Filtrar Grupos..." onkeyup="Editor.renderGroups()" class="search-input">
                </div>
                <div id="list-groups" class="list-container"></div>
            </div>
            <div class="col-content">
                <div class="search-bar flex gap-2">
                    <input type="text" id="search-channels" placeholder="Filtrar Canais..." onkeyup="Editor.renderChannels()" class="search-input flex-1">
                    <button class="text-xs font-bold uppercase text-gray-400 hover:text-white px-3" onclick="Editor.sortChannels()">A-Z</button>
                </div>
                <div id="list-channels" class="list-container"></div>
            </div>
        </section>

        <section id="page-theater" class="split-view hidden">
            <div class="col-sidebar">
                <div class="p-4 border-b border-white/10 font-bold text-cyan-500 text-xs uppercase">Grupos</div>
                <div id="theater-groups" class="list-container"></div>
            </div>
            <div class="col-content">
                <div class="video-wrapper">
                    <video id="main-player" controls autoplay></video>
                </div>
                <div class="theater-channels">
                    <div id="theater-grid" class="channel-card-grid"></div>
                </div>
            </div>
        </section>

    </div>

    <div id="toast-container"></div>

    <div id="modal-login" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Acesso Seguro</h3>
                <i class="fa-solid fa-xmark cursor-pointer" onclick="UI.toggleModal('modal-login', false)"></i>
            </div>
            <div class="space-y-4">
                <input type="email" id="login-email" placeholder="Seu E-mail" class="w-full bg-black/20 border border-white/10 p-3 rounded text-white outline-none">
                <button onclick="App.login()" class="w-full btn-primary py-3">Entrar / Criar Conta</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INDEXEDDB WRAPPER (O CÉREBRO) ---
        const DB = {
            dbName: 'GeminiTV_DB_v7',
            version: 1,
            db: null,
            
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('playlists')) {
                            db.createObjectStore('playlists', { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        console.log("IndexedDB Conectado.");
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject("Erro ao abrir DB");
                });
            },

            async savePlaylist(playlist) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('playlists', 'readwrite');
                    const store = tx.objectStore('playlists');
                    store.put(playlist);
                    tx.oncomplete = () => resolve(true);
                    tx.onerror = () => reject("Erro ao salvar");
                });
            },

            async getAllPlaylists() {
                return new Promise((resolve, reject) => {
                    if(!this.db) return resolve([]);
                    const tx = this.db.transaction('playlists', 'readonly');
                    const store = tx.objectStore('playlists');
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                });
            },

            async deletePlaylist(id) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('playlists', 'readwrite');
                    tx.objectStore('playlists').delete(id);
                    tx.oncomplete = () => resolve(true);
                });
            }
        };

        // --- 2. APP CORE ---
        const App = {
            user: null,
            playlists: [],
            currentPL: null,
            currentGroup: null,

            async start() {
                await DB.init();
                this.checkUser();
                await this.loadData();
                this.nav('home');
            },

            checkUser() {
                const u = localStorage.getItem('gtv_user_session');
                if(u) {
                    this.user = JSON.parse(u);
                    document.getElementById('user-display').innerHTML = `
                        <div class="text-right mr-2"><div class="text-[10px] text-cyan-500 uppercase font-bold">Olá</div><div class="text-xs font-bold">${this.user.email.split('@')[0]}</div></div>
                        <i class="fa-solid fa-power-off cursor-pointer hover:text-red-500" onclick="App.logout()"></i>`;
                }
            },

            login() {
                const email = document.getElementById('login-email').value;
                if(!email) return UI.toast("Digite um e-mail", "error");
                this.user = { email: email };
                localStorage.setItem('gtv_user_session', JSON.stringify(this.user));
                UI.toggleModal('modal-login', false);
                this.checkUser();
                UI.toast("Login realizado com sucesso");
            },

            logout() {
                if(confirm("Sair do sistema?")) {
                    localStorage.removeItem('gtv_user_session');
                    location.reload();
                }
            },

            async loadData() {
                this.playlists = await DB.getAllPlaylists();
                UI.renderHome();
                UI.renderPlaylistsTable();
            },

            async importUI() {
                const url = prompt("Cole a URL M3U:");
                if(!url) return;
                
                UI.toast("Baixando lista... Aguarde.");
                try {
                    // Proxy Bypass CORS
                    const res = await fetch(`https://geminitv-proxy.jcdoni.workers.dev/?url=${encodeURIComponent(url)}`);
                    if(!res.ok) throw new Error("Erro no download");
                    const text = await res.text();
                    
                    const lines = text.split('\n');
                    let chans = [], groups = new Set();
                    
                    // Parse Rápido
                    for(let i=0; i<lines.length; i++) {
                        if(lines[i].startsWith('#EXTINF:')) {
                            const info = lines[i];
                            const name = info.split(',')[1] || "Canal Sem Nome";
                            const meta = info.split(',')[0];
                            const g = (meta.match(/group-title="([^"]+)"/) || ["","GERAL"])[1].toUpperCase();
                            const logo = (meta.match(/tvg-logo="([^"]+)"/) || ["",""])[1];
                            const idStr = (meta.match(/tvg-id="([^"]+)"/) || ["",""])[1];
                            
                            groups.add(g);
                            
                            // Pega URL na proxima linha
                            let urlLink = "";
                            if(lines[i+1] && lines[i+1].startsWith('http')) urlLink = lines[i+1].trim();
                            
                            chans.push({ id: crypto.randomUUID(), nome: name.trim(), grupo: g, logo, epg: idStr, url: urlLink, oculto: false });
                        }
                    }

                    const newPL = {
                        id: Date.now(),
                        name: "Playlist Importada " + (this.playlists.length + 1),
                        source: url,
                        channels: chans,
                        groups: Array.from(groups).sort()
                    };

                    await DB.savePlaylist(newPL);
                    await this.loadData();
                    UI.toast(`Sucesso! ${chans.length} canais importados.`);
                    
                } catch(e) {
                    console.error(e);
                    UI.toast("Falha ao importar. Verifique a URL.", "error");
                }
            },

            async deletePL(id) {
                if(confirm("Tem certeza? Essa ação é irreversível.")) {
                    await DB.deletePlaylist(id);
                    await this.loadData();
                    UI.toast("Playlist removida.");
                }
            },

            nav(page) {
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.glass-nav span').forEach(el => el.classList.remove('active-nav'));
                
                document.getElementById('page-'+page).classList.remove('hidden');
                const navBtn = document.getElementById('nav-'+page);
                if(navBtn) navBtn.classList.add('active-nav');

                if(page === 'editor') Editor.init();
                if(page === 'theater') Theater.init();
            }
        };

        // --- 3. EDITOR LOGIC (BLINDADO) ---
        const Editor = {
            init() {
                const sel = document.getElementById('editor-pl-select');
                sel.innerHTML = `<option value="">Selecione uma Playlist...</option>` + 
                                App.playlists.map(p => `<option value="${p.id}" ${App.currentPL && App.currentPL.id === p.id ? 'selected':''}>${p.name}</option>`).join('');
                
                if(App.currentPL) {
                    if(!App.currentGroup && App.currentPL.groups.length > 0) App.currentGroup = App.currentPL.groups[0];
                    this.renderGroups();
                    this.renderChannels();
                }
            },

            switchPL(id) {
                if(!id) return;
                App.currentPL = App.playlists.find(p => p.id == id);
                App.currentGroup = App.currentPL.groups[0];
                this.renderGroups();
                this.renderChannels();
            },

            renderGroups() {
                const term = document.getElementById('search-groups').value.toUpperCase();
                const list = document.getElementById('list-groups');
                
                const filtered = App.currentPL.groups.filter(g => g.includes(term));
                
                list.innerHTML = filtered.map(g => `
                    <div class="item-row ${App.currentGroup === g ? 'active' : ''}" onclick="Editor.selectGroup('${g}')">
                        <span class="text-xs font-bold truncate flex-1">${g}</span>
                        <div class="row-actions">
                            <i class="fa-solid fa-eye" onclick="Editor.toggleGroup(event, '${g}')"></i>
                            <i class="fa-solid fa-pen" onclick="Editor.renameGroup(event, '${g}')"></i>
                            <i class="fa-solid fa-trash" onclick="Editor.deleteGroup(event, '${g}')"></i>
                        </div>
                    </div>
                `).join('');
            },

            renderChannels() {
                if(!App.currentGroup) return;
                const term = document.getElementById('search-channels').value.toUpperCase();
                const list = document.getElementById('list-channels');
                
                const chans = App.currentPL.channels.filter(c => c.grupo === App.currentGroup && c.nome.toUpperCase().includes(term));
                
                list.innerHTML = chans.map(c => `
                    <div class="item-row ${c.oculto ? 'hidden-item' : ''}">
                        <img src="${c.logo || 'https://via.placeholder.com/40'}" class="w-8 h-8 object-contain mr-3 bg-white/5 rounded">
                        <div class="flex-1 min-w-0 mr-4">
                            <div class="text-xs font-bold truncate" id="name-${c.id}">${c.nome}</div>
                            <div class="text-[9px] text-gray-500 truncate">${c.epg || 'Sem ID'}</div>
                        </div>
                        <div class="row-actions">
                             <i class="fa-solid fa-pen" onclick="Editor.renameChannel(event, '${c.id}')"></i>
                             <i class="fa-solid ${c.oculto ? 'fa-eye-slash text-red-400' : 'fa-eye'}" onclick="Editor.toggleChannel(event, '${c.id}')"></i>
                             <i class="fa-solid fa-trash" onclick="Editor.deleteChannel(event, '${c.id}')"></i>
                        </div>
                    </div>
                `).join('');
            },

            // AÇÕES BLINDADAS (stopPropagation)
            selectGroup(g) { App.currentGroup = g; this.renderGroups(); this.renderChannels(); },

            renameGroup(e, oldG) {
                e.stopPropagation();
                const newG = prompt("Novo nome do grupo:", oldG);
                if(newG && newG !== oldG) {
                    const upG = newG.toUpperCase();
                    // Atualiza canais
                    App.currentPL.channels.forEach(c => { if(c.grupo === oldG) c.grupo = upG; });
                    // Atualiza lista grupos
                    const idx = App.currentPL.groups.indexOf(oldG);
                    App.currentPL.groups[idx] = upG;
                    App.currentGroup = upG;
                    DB.savePlaylist(App.currentPL);
                    this.renderGroups();
                    this.renderChannels();
                }
            },

            deleteGroup(e, g) {
                e.stopPropagation();
                if(confirm(`Apagar grupo ${g} e TODOS os seus canais?`)) {
                    App.currentPL.channels = App.currentPL.channels.filter(c => c.grupo !== g);
                    App.currentPL.groups = App.currentPL.groups.filter(x => x !== g);
                    App.currentGroup = App.currentPL.groups[0] || null;
                    DB.savePlaylist(App.currentPL);
                    this.renderGroups();
                    this.renderChannels();
                }
            },

            renameChannel(e, id) {
                e.stopPropagation();
                const c = App.currentPL.channels.find(x => x.id === id);
                const newName = prompt("Novo nome:", c.nome);
                if(newName) {
                    c.nome = newName;
                    DB.savePlaylist(App.currentPL);
                    this.renderChannels();
                }
            },

            toggleChannel(e, id) {
                e.stopPropagation();
                const c = App.currentPL.channels.find(x => x.id === id);
                c.oculto = !c.oculto;
                DB.savePlaylist(App.currentPL);
                this.renderChannels();
            },

            deleteChannel(e, id) {
                e.stopPropagation();
                App.currentPL.channels = App.currentPL.channels.filter(x => x.id !== id);
                DB.savePlaylist(App.currentPL);
                this.renderChannels();
            },
            
            sortChannels() {
                if(!App.currentGroup) return;
                App.currentPL.channels.sort((a,b) => a.nome.localeCompare(b.nome));
                DB.savePlaylist(App.currentPL);
                this.renderChannels();
            }
        };

        // --- 4. THEATER MODE ---
        const Theater = {
            hls: null,
            init() {
                if(!App.currentPL && App.playlists.length > 0) App.currentPL = App.playlists[0];
                if(!App.currentPL) return;
                if(!App.currentGroup && App.currentPL.groups.length > 0) App.currentGroup = App.currentPL.groups[0];
                
                this.renderGroups();
                this.renderGrid();
            },

            renderGroups() {
                document.getElementById('theater-groups').innerHTML = App.currentPL.groups.map(g => `
                    <div class="p-3 border-b border-white/5 cursor-pointer hover:bg-white/5 text-xs font-bold text-gray-400 hover:text-white transition-all ${App.currentGroup === g ? 'text-cyan-500 bg-white/5' : ''}" onclick="Theater.selectGroup('${g}')">
                        ${g}
                    </div>
                `).join('');
            },

            selectGroup(g) {
                App.currentGroup = g;
                this.renderGroups();
                this.renderGrid();
            },

            renderGrid() {
                const chans = App.currentPL.channels.filter(c => c.grupo === App.currentGroup && !c.oculto);
                document.getElementById('theater-grid').innerHTML = chans.map(c => `
                    <div class="channel-card" onclick="Theater.play('${c.url}')">
                        <img src="${c.logo || 'https://via.placeholder.com/50'}" loading="lazy">
                        <div class="text-[10px] font-bold truncate">${c.nome}</div>
                    </div>
                `).join('');
            },

            play(url) {
                const video = document.getElementById('main-player');
                if (Hls.isSupported()) {
                    if(this.hls) this.hls.destroy();
                    this.hls = new Hls();
                    this.hls.loadSource(url);
                    this.hls.attachMedia(video);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = url;
                    video.play();
                }
            }
        };

        // --- 5. UI HELPERS ---
        const UI = {
            toggleModal(id, show) {
                document.getElementById(id).style.display = show ? 'flex' : 'none';
            },

            toast(msg, type='success') {
                const box = document.createElement('div');
                box.className = 'toast';
                if(type === 'error') box.style.borderLeftColor = '#ef4444';
                box.innerHTML = `<i class="fa-solid ${type==='error'?'fa-circle-exclamation':'fa-check-circle'}"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(box);
                setTimeout(() => box.remove(), 3000);
            },

            renderHome() {
                const grid = document.getElementById('home-grid');
                if(App.playlists.length === 0) {
                    grid.innerHTML = `<div class="col-span-4 text-center opacity-30 py-10">Nenhuma playlist salva.</div>`;
                    return;
                }
                grid.innerHTML = App.playlists.map(p => `
                    <div class="bg-fire-card border border-white/10 rounded-lg p-5 hover:border-cyan-500 cursor-pointer transition-all" onclick="Editor.switchPL(${p.id}); App.nav('editor')">
                        <div class="font-bold truncate text-white mb-1">${p.name}</div>
                        <div class="text-xs text-gray-500 mb-4">${p.channels.length} canais</div>
                        <div class="w-full bg-white/5 h-1 rounded-full"><div class="bg-cyan-500 h-1 rounded-full" style="width: 70%"></div></div>
                    </div>
                `).join('');
            },

            renderPlaylistsTable() {
                document.getElementById('pl-body').innerHTML = App.playlists.map(p => `
                    <tr class="hover:bg-white/5">
                        <td class="font-bold">${p.name}</td>
                        <td class="text-xs text-gray-400 truncate max-w-[150px]">${p.source}</td>
                        <td>${p.groups.length}</td>
                        <td>${p.channels.length}</td>
                        <td>
                            <div class="flex gap-3 text-gray-400">
                                <i class="fa-solid fa-pen cursor-pointer hover:text-cyan-500" onclick="alert('Edição de metadados em breve')"></i>
                                <i class="fa-solid fa-trash cursor-pointer hover:text-red-500" onclick="App.deletePL(${p.id})"></i>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        };

        // BOOT
        window.onload = () => App.start();

    </script>
</body>
</html>
