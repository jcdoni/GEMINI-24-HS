<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini TV - Professional Editor</title>
    <style>
        :root {
            --bg-dark: #0f111a;
            --sidebar-bg: #1a1d29;
            --accent: #00f2ff;
            --text-main: #e0e0e0;
            --border: #2d3245;
            --danger: #ff4d4d;
            --success: #00ff88;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar - Estilo M3U4U */
        #sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .logo-area {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 15px;
        }

        .logo-area h2 { color: var(--accent); margin: 0; font-size: 1.5rem; letter-spacing: 2px; }

        .group-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .group-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
        }

        .group-item:hover { background: rgba(0, 242, 255, 0.1); }
        .group-item.active { background: var(--accent); color: #000; font-weight: bold; }

        /* Main Content */
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
        }

        /* Toolbar - Os 15 BotÃµes do Memorial */
        .toolbar {
            padding: 15px;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .toolbar button {
            padding: 8px 12px;
            background: #252a3d;
            color: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
        }

        .toolbar button:hover { border-color: var(--accent); color: var(--accent); }
        .btn-primary { background: var(--accent) !important; color: #000 !important; font-weight: bold; }

        /* Search Area */
        .search-container {
            padding: 10px 20px;
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            background: #252a3d;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            border-radius: 5px;
            flex-grow: 1;
        }

        /* Tabela Estilizada */
        .table-container {
            flex-grow: 1;
            overflow: auto;
            padding: 0 20px;
        }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { position: sticky; top: 0; background: var(--sidebar-bg); padding: 15px; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        
        tr:hover { background: rgba(255, 255, 255, 0.03); }

        .status-bar {
            padding: 5px 20px;
            background: var(--accent);
            color: #000;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="logo-area">
        <h2>GEMINI TV ðŸ§¬</h2>
        <small>DNA PROTOCOL ACTIVE</small>
    </div>
    <div class="group-list" id="listaGrupos">
        <div class="group-item active">Todos os Canais</div>
    </div>
</div>

<div id="main-content">
    <div class="toolbar">
        <button class="btn-primary" onclick="promptUrl()">IMPORTAR M3U</button>
        <button onclick="aplicarDNA()">APLICAR DNA (.BRASIL.)</button>
        <button onclick="limparNomes()">LIMPAR NOMES</button>
        <button onclick="removerDuplicados()">REMOVER DUPLICADOS</button>
        <button onclick="bulkEditGroup()">MOVER SELECIONADOS</button>
        <button onclick="addPrefix()">ADD PREFIXO</button>
        <button onclick="addSuffix()">ADD SUFIXO</button>
        <button onclick="deleteEmptyGroups()">DEL GRUPOS VAZIOS</button>
        <button onclick="fixEpgLinks()">CORRIGIR EPG</button>
        <button onclick="sortAlpha()">ORDEM ALFABÃ‰TICA</button>
        <button onclick="clearAll()" style="color: var(--danger)">LIMPAR TUDO</button>
        <button class="btn-primary" onclick="exportarM3U()" style="margin-left: auto;">EXPORTAR M3U</button>
    </div>

    <div class="search-container">
        <input type="text" id="filtroNome" placeholder="Pesquisar canal ou grupo..." onkeyup="filtrarCanais()">
        <input type="text" id="m3uInput" placeholder="URL da Lista M3U" style="display: none;">
    </div>

    <div class="table-container">
        <table id="tabelaCanais">
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleSelectAll(this)"></th>
                    <th>NOME DO CANAL</th>
                    <th>GRUPO / CATEGORIA</th>
                    <th>EPG ID</th>
                    <th>URL DO STREAM</th>
                </tr>
            </thead>
            <tbody id="corpoTabela"></tbody>
        </table>
    </div>

    <div class="status-bar" id="statusBar">SISTEMA ONLINE | AGUARDANDO LISTA</div>
</div>

<script>
    let canaisGlobal = [];
    const PROXY_URL = "https://geminitv-proxy.jcdoni.workers.dev/?url=";

    async function promptUrl() {
        const url = prompt("Cole a URL da lista M3U:");
        if (url) carregarLista(url);
    }

    async function carregarLista(url) {
        updateStatus("Conectando ao Motor Cloudflare...");
        try {
            const response = await fetch(PROXY_URL + encodeURIComponent(url));
            const data = await response.text();
            processarM3U(data);
            updateStatus("Lista carregada: " + canaisGlobal.length + " canais.");
        } catch (e) {
            alert("Erro ao carregar via Worker!");
            updateStatus("Erro de conexÃ£o.");
        }
    }

    function processarM3U(texto) {
        const linhas = texto.split('\n');
        canaisGlobal = [];
        let item = {};

        linhas.forEach(linha => {
            if (linha.startsWith('#EXTINF:')) {
                const nome = linha.split(',')[1] || "Sem Nome";
                const grupo = linha.match(/group-title="([^"]+)"/);
                const epg = linha.match(/tvg-id="([^"]+)"/);
                item = {
                    nome: nome.trim(),
                    grupo: grupo ? grupo[1] : "GERAL",
                    epg: epg ? epg[1] : "",
                    selecionado: false
                };
            } else if (linha.startsWith('http')) {
                item.url = linha.trim();
                canaisGlobal.push(item);
                item = {};
            }
        });
        atualizarInterface();
    }

    function atualizarInterface() {
        renderizarTabela(canaisGlobal);
        renderizarGrupos();
    }

    function renderizarTabela(dados) {
        const corpo = document.getElementById('corpoTabela');
        corpo.innerHTML = "";
        dados.forEach((c, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" ${c.selecionado ? 'checked' : ''} onchange="canaisGlobal[${i}].selecionado = this.checked"></td>
                <td contenteditable="true" onblur="canaisGlobal[${i}].nome = this.innerText">${c.nome}</td>
                <td contenteditable="true" onblur="canaisGlobal[${i}].grupo = this.innerText">${c.grupo}</td>
                <td contenteditable="true" onblur="canaisGlobal[${i}].epg = this.innerText">${c.epg}</td>
                <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis;">${c.url}</td>
            `;
            corpo.appendChild(tr);
        });
    }

    function renderizarGrupos() {
        const sidebar = document.getElementById('listaGrupos');
        const grupos = [...new Set(canaisGlobal.map(c => c.grupo))];
        sidebar.innerHTML = '<div class="group-item active" onclick="filtrarPorGrupo(\'all\')">Todos os Canais <span>' + canaisGlobal.length + '</span></div>';
        
        grupos.forEach(g => {
            const count = canaisGlobal.filter(c => c.grupo === g).length;
            sidebar.innerHTML += `<div class="group-item" onclick="filtrarPorGrupo('${g}')">${g} <span>${count}</span></div>`;
        });
    }

    function aplicarDNA() {
        canaisGlobal.forEach(c => {
            if (c.epg && !c.epg.endsWith('.BRASIL.')) {
                c.epg = c.epg.split('.')[0] + ".BRASIL.";
            } else if (!c.epg) {
                c.epg = c.nome.replace(/\s+/g, '').toUpperCase() + ".BRASIL.";
            }
        });
        atualizarInterface();
        updateStatus("Protocolo DNA Aplicado com Sucesso.");
    }

    function limparNomes() {
        canaisGlobal.forEach(c => {
            c.nome = c.nome.replace(/\[.*?\]/g, "").replace(/\{.*?\}/g, "").trim();
        });
        atualizarInterface();
    }

    function filtrarCanais() {
        const busca = document.getElementById('filtroNome').value.toLowerCase();
        const filtrados = canaisGlobal.filter(c => 
            c.nome.toLowerCase().includes(busca) || c.grupo.toLowerCase().includes(busca)
        );
        renderizarTabela(filtrados);
    }

    function updateStatus(msg) {
        document.getElementById('statusBar').innerText = "SISTEMA: " + msg.toUpperCase();
    }

    function exportarM3U() {
        let m3u = "#EXTM3U\n";
        canaisGlobal.forEach(c => {
            m3u += `#EXTINF:-1 tvg-id="${c.epg}" group-title="${c.grupo}",${c.nome}\n${c.url}\n`;
        });
        const blob = new Blob([m3u], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "GeminiTV_Master.m3u";
        a.click();
    }

    function toggleSelectAll(source) {
        canaisGlobal.forEach(c => c.selecionado = source.checked);
        renderizarTabela(canaisGlobal);
    }
</script>

</body>
</html>
