<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEMINI TV | V29 EDITOR DNA</title>
    <style>
        :root { --primary: #00ff88; --bg: #0b0b0b; --surface: #151515; --neon: 0 0 15px rgba(0, 255, 136, 0.3); }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Estilo Fire TV */
        .sidebar { width: 70px; background: #000; border-right: 1px solid #222; display: flex; flex-direction: column; align-items: center; padding: 20px 0; transition: 0.3s; z-index: 1000; }
        .sidebar:hover { width: 200px; }
        .nav-item { width: 100%; height: 50px; display: flex; align-items: center; padding: 0 25px; cursor: pointer; color: #666; transition: 0.2s; white-space: nowrap; overflow: hidden; }
        .nav-item:hover, .nav-item.active { color: var(--primary); background: rgba(0,255,136,0.05); border-left: 4px solid var(--primary); }
        .nav-item span { margin-left: 20px; opacity: 0; font-weight: bold; }
        .sidebar:hover .nav-item span { opacity: 1; }

        /* Area Principal */
        .main { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }

        /* Card de Edi√ß√£o DNA */
        .card { background: var(--surface); border-radius: 12px; padding: 15px; border: 1px solid #222; transition: 0.3s; position: relative; }
        .card:hover { border-color: var(--primary); box-shadow: var(--neon); }
        .card img { width: 60px; height: 40px; object-fit: contain; background: #000; border-radius: 5px; margin-bottom: 10px; }
        .card input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 8px; margin: 5px 0; border-radius: 5px; font-size: 12px; box-sizing: border-box; }
        .card label { font-size: 10px; color: #888; text-transform: uppercase; font-weight: bold; }
        .id-badge { color: var(--primary); font-size: 10px; font-weight: bold; margin-top: 5px; display: block; }

        /* Modal e Inputs */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: #111; padding: 30px; border-radius: 20px; width: 90%; max-width: 450px; border: 1px solid #333; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #444; color: #fff; margin-top: 10px; width: 100%; }
        
        #loading { position: fixed; top: 20px; right: 20px; background: var(--primary); color: #000; padding: 10px 20px; border-radius: 5px; display: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading">PROCESSANDO DNA...</div>

    <nav class="sidebar">
        <div class="nav-item active">üè†<span>DASHBOARD</span></div>
        <div class="nav-item" onclick="openModal('import-modal')">üì•<span>IMPORTAR</span></div>
        <div class="nav-item" onclick="openModal('config-modal')">‚öôÔ∏è<span>CONFIG</span></div>
        <div class="nav-item" onclick="exportToGithub()" style="margin-top: auto; color: #00ff88;">üöÄ<span>ENVIAR GITHUB</span></div>
    </nav>

    <main class="main">
        <div class="header-actions">
            <h1>GEMINI <span style="color:var(--primary)">EDITOR DNA</span></h1>
            <div id="counter">Canais: 0</div>
        </div>
        <div id="grid-area" class="grid"></div>
    </main>

    <div class="overlay" id="import-modal">
        <div class="modal">
            <h2>IMPORTAR LISTA</h2>
            <input type="text" id="m3u-url" placeholder="URL da Lista M3U" style="width:100%; padding:12px; background:#000; color:#fff; border:1px solid #333; border-radius:8px; box-sizing:border-box;">
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="importM3U()">INICIAR HIGIENIZA√á√ÉO</button>
            <button class="btn btn-outline" onclick="closeModal('import-modal')">CANCELAR</button>
        </div>
    </div>

    <div class="overlay" id="config-modal">
        <div class="modal">
            <h2>SETUP GITHUB</h2>
            <input type="text" id="gh-token" placeholder="Token GitHub" class="btn-outline" style="text-align:left; padding:12px;">
            <input type="text" id="gh-repo" placeholder="Reposit√≥rio (usuario/repo)" class="btn-outline" style="text-align:left; padding:12px;">
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="saveConfig()">SALVAR AJUSTES</button>
            <button class="btn btn-outline" onclick="closeModal('config-modal')">FECHAR</button>
        </div>
    </div>

    <script>
        let CHANNELS = JSON.parse(localStorage.getItem('gemini_db')) || [];
        let CONFIG = JSON.parse(localStorage.getItem('gemini_config')) || { token: '', repo: '', user: '' };

        window.onload = () => { 
            render();
            document.getElementById('gh-token').value = CONFIG.token;
            document.getElementById('gh-repo').value = CONFIG.repo;
        };

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- MOTOR DNA: HIGIENIZADOR ULTRA ---
        function higienizarDNA(texto) {
            if (!texto) return "";
            let n = texto.toString().toUpperCase();
            n = n.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/√á/g, "C");
            
            // Exterm√≠nio de Prefixos e Tags T√©cnicas
            n = n.replace(/^[A-Z]{2,3}\s*[:|/-]\s*/i, "");
            const lixo = [/\b(1080P|720P|4K|FHD|HD|SD|RAW|60FPS|H265|HEVC|BR:|PT:|US:)\b/g, /[^A-Z0-9\s]/g];
            lixo.forEach(reg => n = n.replace(reg, " "));
            
            return n.replace(/\s+/g, " ").trim();
        }

        function generateID(nome) {
            return nome.replace(/[^A-Z0-9]/g, "") + ".BRASIL";
        }

        async function importM3U() {
            const url = document.getElementById('m3u-url').value;
            const loader = document.getElementById('loading');
            loader.style.display = 'block';
            
            try {
                const proxy = "https://api.allorigins.win/raw?url=";
                const res = await fetch(proxy + encodeURIComponent(url));
                const text = await res.text();
                const lines = text.split('\n');
                
                let temp = [];
                for(let i=0; i<lines.length; i++) {
                    if(lines[i].includes("#EXTINF:")) {
                        let nameRaw = lines[i].split(',').pop();
                        let nomeLimpo = higienizarDNA(nameRaw);
                        let logo = lines[i].match(/tvg-logo="(.*?)"/)?.[1] || "";
                        let group = lines[i].match(/group-title="(.*?)"/)?.[1] || "GERAL";
                        let stream = lines[i+1]?.trim();

                        if(stream && !stream.startsWith("#")) {
                            temp.push({
                                nome: nomeLimpo,
                                id: generateID(nomeLimpo),
                                logo: logo,
                                grupo: higienizarDNA(group),
                                url: stream
                            });
                        }
                    }
                }
                CHANNELS = temp;
                saveData();
                render();
                closeModal('import-modal');
            } catch(e) { alert("Erro ao carregar lista."); }
            loader.style.display = 'none';
        }

        function render() {
            const area = document.getElementById('grid-area');
            document.getElementById('counter').innerText = `Canais: ${CHANNELS.length}`;
            area.innerHTML = CHANNELS.map((c, index) => `
                <div class="card">
                    <img src="${c.logo}" onerror="this.src='https://via.placeholder.com/60x40/000/00ff88?text=TV'">
                    <label>Nome do Canal</label>
                    <input type="text" value="${c.nome}" onchange="updateChannel(${index}, 'nome', this.value)">
                    <label>Grupo</label>
                    <input type="text" value="${c.grupo}" onchange="updateChannel(${index}, 'grupo', this.value)">
                    <span class="id-badge">ID: ${c.id}</span>
                </div>
            `).join('');
        }

        function updateChannel(index, field, value) {
            CHANNELS[index][field] = field === 'nome' ? higienizarDNA(value) : value;
            if(field === 'nome') CHANNELS[index].id = generateID(CHANNELS[index].nome);
            saveData();
            render();
        }

        function saveData() { localStorage.setItem('gemini_db', JSON.stringify(CHANNELS)); }
        function saveConfig() {
            CONFIG.token = document.getElementById('gh-token').value;
            CONFIG.repo = document.getElementById('gh-repo').value;
            localStorage.setItem('gemini_config', JSON.stringify(CONFIG));
            closeModal('config-modal');
        }

        async function exportToGithub() {
            if(!CONFIG.token || !CONFIG.repo) return alert("Configure o Token e Repo primeiro!");
            const loader = document.getElementById('loading');
            loader.innerText = "ENVIANDO PARA GITHUB...";
            loader.style.display = 'block';

            let m3u = "#EXTM3U\n";
            CHANNELS.forEach(c => {
                m3u += `#EXTINF:-1 tvg-id="${c.id}" tvg-logo="${c.logo}" group-title="${c.grupo}", ${c.nome}\n${c.url}\n`;
            });

            const url = `https://api.github.com/repos/${CONFIG.repo}/contents/GEMINI_24HS.m3u`;
            
            try {
                const getFile = await fetch(url, { headers: { Authorization: `token ${CONFIG.token}` }});
                const fileData = await getFile.json();
                const sha = fileData.sha || null;

                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { Authorization: `token ${CONFIG.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Update DNA Web V29",
                        content: btoa(unescape(encodeURIComponent(m3u))),
                        sha: sha
                    })
                });

                if(res.ok) alert("üöÄ SUCESSO! Arquivo salvo no GitHub.");
                else alert("Erro ao salvar.");
            } catch(e) { alert("Falha na conex√£o GitHub."); }
            loader.style.display = 'none';
        }
    </script>
</body>
</html>
