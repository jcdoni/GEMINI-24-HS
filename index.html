<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini TV | Enterprise IPTV Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #09090b; color: #fafafa; }
        .glass-card { background: rgba(24, 24, 27, 0.8); backdrop-filter: blur(8px); border: 1px solid #27272a; }
        .sidebar-btn.active { background: #27272a; color: #22d3ee; border-right: 2px solid #22d3ee; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn-action { transition: all 0.2s; border: 1px solid #3f3f46; }
        .btn-action:hover { background: #27272a; border-color: #22d3ee; color: #22d3ee; }
        .table-row:hover { background: rgba(39, 39, 42, 0.5); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 glass-card flex flex-col">
        <div class="p-6">
            <h1 class="text-xl font-bold tracking-tighter text-cyan-400">GEMINI TV <span class="text-[10px] text-slate-500 font-mono">PRO</span></h1>
        </div>
        
        <nav class="flex-1 px-3 space-y-1">
            <button onclick="switchTab('home')" id="btn-home" class="sidebar-btn active w-full flex items-center p-3 rounded-lg text-sm font-medium transition-all">
                <i class="fa-solid fa-house mr-3 w-5"></i> Dashboard
            </button>
            <button onclick="switchTab('database')" id="btn-database" class="sidebar-btn w-full flex items-center p-3 rounded-lg text-sm font-medium transition-all text-slate-400">
                <i class="fa-solid fa-database mr-3 w-5"></i> Meus Projetos
            </button>
            <button onclick="switchTab('editor')" id="btn-editor" class="sidebar-btn w-full flex items-center p-3 rounded-lg text-sm font-medium transition-all text-slate-400">
                <i class="fa-solid fa-wand-magic-sparkles mr-3 w-5"></i> Editor Master
            </button>
        </nav>

        <div class="p-4 border-t border-zinc-800">
            <button onclick="promptImport()" class="w-full py-2 bg-cyan-600 hover:bg-cyan-500 text-black font-bold rounded-md text-xs transition-all">
                <i class="fa-solid fa-plus mr-1"></i> NOVO PROJETO
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        
        <header class="h-14 border-b border-zinc-800 flex items-center justify-between px-8 bg-zinc-950/50">
            <div id="current-project-name" class="text-sm font-medium text-slate-400">Nenhum projeto selecionado</div>
            <div class="flex items-center space-x-4">
                <button onclick="exportarM3U()" class="text-xs font-semibold hover:text-cyan-400 transition-colors">EXPORTAR M3U</button>
                <div class="w-8 h-8 rounded-full bg-zinc-800 border border-zinc-700"></div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
            
            <section id="tab-home" class="tab-content active space-y-8">
                <div>
                    <h2 class="text-3xl font-bold">Bem-vindo, Comandante.</h2>
                    <p class="text-slate-500 mt-2">Gerencie suas listas M3U com precisão cirúrgica.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass-card p-6 rounded-2xl">
                        <p class="text-xs font-medium text-slate-500 uppercase">Canais Processados</p>
                        <h3 class="text-4xl font-bold mt-2" id="stat-channels">0</h3>
                    </div>
                    <div class="glass-card p-6 rounded-2xl">
                        <p class="text-xs font-medium text-slate-500 uppercase">EPG Brasilizado</p>
                        <h3 class="text-4xl font-bold mt-2 text-cyan-400" id="stat-dna">0%</h3>
                    </div>
                    <div class="glass-card p-6 rounded-2xl">
                        <p class="text-xs font-medium text-slate-500 uppercase">Última Edição</p>
                        <h3 class="text-xl font-bold mt-4" id="stat-date">--/--</h3>
                    </div>
                </div>
            </section>

            <section id="tab-database" class="tab-content space-y-6">
                <h2 class="text-2xl font-bold">Base de Dados</h2>
                <div id="project-list" class="grid grid-cols-1 gap-4">
                    <p class="text-slate-500 italic">Nenhuma lista salva na base local.</p>
                </div>
            </section>

            <section id="tab-editor" class="tab-content h-full flex flex-col">
                <div class="flex flex-wrap gap-2 mb-6 p-4 glass-card rounded-xl">
                    <button onclick="limparNomes()" class="btn-action px-3 py-2 rounded-lg text-xs flex items-center"><i class="fa-solid fa-scissors mr-2"></i> Limpar Nomes</button>
                    <button onclick="removerDuplicados()" class="btn-action px-3 py-2 rounded-lg text-xs flex items-center"><i class="fa-solid fa-clone mr-2"></i> Remover Duplicados</button>
                    <button onclick="aplicarDNA()" class="btn-action px-3 py-2 rounded-lg text-xs flex items-center text-cyan-400 font-bold"><i class="fa-solid fa-dna mr-2"></i> Aplicar DNA</button>
                    <button onclick="addPrefix()" class="btn-action px-3 py-2 rounded-lg text-xs flex items-center"><i class="fa-solid fa-heading mr-2"></i> Add Prefixo</button>
                    <button onclick="addSuffix()" class="btn-action px-3 py-2 rounded-lg text-xs flex items-center"><i class="fa-solid fa-t mr-2"></i> Add Sufixo</button>
                    <button onclick="fixEpgLinks()" class="btn-action px-3 py-2 rounded-lg text-xs flex items-center"><i class="fa-solid fa-link-slash mr-2"></i> Corrigir EPG</button>
                    <button onclick="deleteEmptyGroups()" class="btn-action px-3 py-2 rounded-lg text-xs flex items-center"><i class="fa-solid fa-folder-minus mr-2"></i> Del Grupos Vazios</button>
                    <button onclick="sortAlpha()" class="btn-action px-3 py-2 rounded-lg text-xs flex items-center"><i class="fa-solid fa-sort mr-2"></i> Ordem A-Z</button>
                    <button onclick="clearAll()" class="btn-action px-3 py-2 rounded-lg text-xs flex items-center text-red-400"><i class="fa-solid fa-trash-can mr-2"></i> Reset</button>
                </div>

                <div class="flex-1 overflow-auto rounded-xl border border-zinc-800">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-zinc-900/50 sticky top-0">
                            <tr>
                                <th class="p-4 font-medium text-slate-500"><input type="checkbox"></th>
                                <th class="p-4 font-medium text-slate-500">CANAL / STREAM</th>
                                <th class="p-4 font-medium text-slate-500">GRUPO</th>
                                <th class="p-4 font-medium text-slate-500">EPG ID (DNA)</th>
                            </tr>
                        </thead>
                        <tbody id="editor-body">
                            </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script>
        let currentList = [];
        let dbProjetos = JSON.parse(localStorage.getItem('gemini_db')) || [];

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active', 'text-cyan-400'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
            if (tabId === 'database') renderDatabase();
        }

        async function promptImport() {
            const url = prompt("URL da Lista M3U:");
            if (!url) return;
            
            const name = prompt("Nome do Projeto:", "Nova Lista " + new Date().toLocaleDateString());
            await fetchList(url, name);
        }

        async function fetchList(url, name) {
            try {
                const res = await fetch(`https://geminitv-proxy.jcdoni.workers.dev/?url=${encodeURIComponent(url)}`);
                const data = await res.text();
                const canais = parseM3U(data);
                
                const projeto = { id: Date.now(), name, canais, date: new Date().toLocaleString() };
                dbProjetos.push(projeto);
                saveDB();
                loadProject(projeto.id);
            } catch (e) { alert("Erro ao importar lista."); }
        }

        function parseM3U(text) {
            const lines = text.split('\n');
            const canais = [];
            let current = {};
            lines.forEach(l => {
                if(l.startsWith('#EXTINF:')) {
                    const group = l.match(/group-title="([^"]+)"/);
                    const epg = l.match(/tvg-id="([^"]+)"/);
                    const logo = l.match(/tvg-logo="([^"]+)"/);
                    current = { 
                        nome: l.split(',')[1]?.trim() || "Sem Nome",
                        grupo: group ? group[1] : "GERAL",
                        epg: epg ? epg[1] : "",
                        logo: logo ? logo[1] : ""
                    };
                } else if(l.startsWith('http')) {
                    current.url = l.trim();
                    canais.push(current);
                }
            });
            return canais;
        }

        function loadProject(id) {
            const p = dbProjetos.find(x => x.id === id);
            currentList = p.canais;
            document.getElementById('current-project-name').innerText = p.name;
            updateStats();
            renderEditor();
            switchTab('editor');
        }

        function renderEditor() {
            const body = document.getElementById('editor-body');
            body.innerHTML = currentList.map((c, i) => `
                <tr class="table-row border-b border-zinc-800/50">
                    <td class="p-4"><input type="checkbox"></td>
                    <td class="p-4 flex items-center">
                        <img src="${c.logo}" class="w-8 h-8 rounded mr-3 bg-zinc-800">
                        <div class="font-medium outline-none" contenteditable="true" onblur="currentList[${i}].nome = this.innerText">${c.nome}</div>
                    </td>
                    <td class="p-4"><span class="bg-zinc-800 px-2 py-1 rounded text-xs outline-none" contenteditable="true" onblur="currentList[${i}].grupo = this.innerText">${c.grupo}</span></td>
                    <td class="p-4 font-mono text-xs text-cyan-500/70 outline-none" contenteditable="true" onblur="currentList[${i}].epg = this.innerText">${c.epg}</td>
                </tr>
            `).join('');
        }

        function renderDatabase() {
            const list = document.getElementById('project-list');
            if (dbProjetos.length === 0) return;
            list.innerHTML = dbProjetos.map(p => `
                <div class="glass-card p-4 rounded-xl flex items-center justify-between">
                    <div>
                        <h4 class="font-bold text-lg">${p.name}</h4>
                        <p class="text-xs text-slate-500">${p.canais.length} canais | ${p.date}</p>
                    </div>
                    <div class="space-x-2">
                        <button onclick="loadProject(${p.id})" class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-xs">ABRIR</button>
                        <button onclick="deleteProject(${p.id})" class="px-4 py-2 bg-red-900/20 text-red-400 rounded-lg text-xs">DEL</button>
                    </div>
                </div>
            `).join('');
        }

        function aplicarDNA() {
            currentList.forEach(c => {
                if (c.epg && !c.epg.endsWith('.BRASIL.')) c.epg = c.epg.split('.')[0] + ".BRASIL.";
                else if (!c.epg) c.epg = c.nome.replace(/\s+/g, '').toUpperCase() + ".BRASIL.";
            });
            renderEditor();
            updateStats();
        }

        function updateStats() {
            document.getElementById('stat-channels').innerText = currentList.length;
            const dnaCount = currentList.filter(c => c.epg.endsWith('.BRASIL.')).length;
            const perc = currentList.length ? Math.round((dnaCount / currentList.length) * 100) : 0;
            document.getElementById('stat-dna').innerText = perc + "%";
            document.getElementById('stat-date').innerText = new Date().toLocaleDateString();
        }

        function saveDB() { localStorage.setItem('gemini_db', JSON.stringify(dbProjetos)); }
        function deleteProject(id) { 
            dbProjetos = dbProjetos.filter(x => x.id !== id); 
            saveDB(); 
            renderDatabase(); 
        }

        // Funções do Memorial Descritivo (Implementação de Lógica)
        function limparNomes() {
            currentList.forEach(c => c.nome = c.nome.replace(/\[.*?\]|\{.*?\}|fhd|4k|sd|h265|vip/gi, "").trim());
            renderEditor();
        }

        function removerDuplicados() {
            const unique = [];
            const urls = new Set();
            currentList.forEach(c => {
                if (!urls.has(c.url)) { urls.add(c.url); unique.push(c); }
            });
            currentList = unique;
            renderEditor();
            updateStats();
        }

        function exportarM3U() {
            let m3u = "#EXTM3U\n";
            currentList.forEach(c => {
                m3u += `#EXTINF:-1 tvg-id="${c.epg}" tvg-logo="${c.logo}" group-title="${c.grupo}",${c.nome}\n${c.url}\n`;
            });
            const blob = new Blob([m3u], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "Gemini_Export.m3u";
            a.click();
        }
    </script>
</body>
</html>
