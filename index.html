<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Editor Gemini TV - DNA Pro</title>
    <style>
        :root {
            --primary: #00ff88;
            --bg: #121212;
            --card: #1e1e1e;
            --text: #ffffff;
        }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .controls { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--primary); }
        input, button { padding: 10px; border-radius: 4px; border: none; margin: 5px; }
        input[type="text"] { width: 60%; background: #333; color: white; }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: scale(1.05); }
        table { width: 100%; border-collapse: collapse; background: var(--card); }
        th, td { padding: 12px; border: 1px solid #333; text-align: left; }
        th { background: #252525; color: var(--primary); }
        .status { color: var(--primary); margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ§¬ Gemini TV - Editor Pro (DNA Ativo)</h2>
    
    <div class="controls">
        <input type="text" id="m3uUrl" placeholder="Cole o link da lista M3U aqui...">
        <button onclick="carregarLista()">CARREGAR LISTA</button>
        <button onclick="aplicarDNA()">APLICAR DNA</button>
        <button onclick="exportarM3U()">EXPORTAR M3U</button>
        <div id="statusMsg" class="status">Sistema pronto.</div>
    </div>

    <table id="tabelaCanais">
        <thead>
            <tr>
                <th>Nome do Canal</th>
                <th>Grupo/Categoria</th>
                <th>EPG ID (BRASIL)</th>
                <th>AÃ§Ãµes</th>
            </tr>
        </thead>
        <tbody id="corpoTabela">
            </tbody>
    </table>
</div>

<script>
    let canaisData = [];
    const PROXY_URL = "https://geminitv-proxy.jcdoni.workers.dev/?url=";

    async function carregarLista() {
        const urlOriginal = document.getElementById('m3uUrl').value;
        if (!urlOriginal) return alert("Insira uma URL!");

        const msg = document.getElementById('statusMsg');
        msg.innerText = "Buscando lista via TÃºnel Cloudflare...";

        try {
            // Uso do motor Cloudflare para pular bloqueios
            const response = await fetch(PROXY_URL + encodeURIComponent(urlOriginal));
            const data = await response.text();
            processarM3U(data);
            msg.innerText = "Lista carregada com sucesso!";
        } catch (error) {
            msg.innerText = "Erro ao carregar lista. Verifique o link ou o Worker.";
            console.error(error);
        }
    }

    function processarM3U(conteudo) {
        const linhas = conteudo.split('\n');
        canaisData = [];
        let canalAtual = {};

        linhas.forEach(linha => {
            if (linha.startsWith('#EXTINF:')) {
                const info = linha;
                const nome = info.split(',')[1] || "Sem Nome";
                const grupoMatch = info.match(/group-title="([^"]+)"/);
                const epgMatch = info.match(/tvg-id="([^"]+)"/);

                canalAtual = {
                    nome: nome.trim(),
                    grupo: grupoMatch ? grupoMatch[1] : "Geral",
                    epg: epgMatch ? epgMatch[1] : ""
                };
            } else if (linha.startsWith('http')) {
                canalAtual.url = linha.trim();
                canaisData.push(canalAtual);
                canalAtual = {};
            }
        });
        renderizarTabela();
    }

    function renderizarTabela() {
        const corpo = document.getElementById('corpoTabela');
        corpo.innerHTML = "";
        canaisData.forEach((canal, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" value="${canal.nome}" onchange="atualizarCanal(${index}, 'nome', this.value)"></td>
                <td><input type="text" value="${canal.grupo}" onchange="atualizarCanal(${index}, 'grupo', this.value)"></td>
                <td><input type="text" value="${canal.epg}" onchange="atualizarCanal(${index}, 'epg', this.value)"></td>
                <td><button onclick="removerCanal(${index})" style="background:#ff4444; color:white;">Remover</button></td>
            `;
            corpo.appendChild(tr);
        });
    }

    function aplicarDNA() {
        canaisData = canaisData.map(canal => {
            let novoEpg = canal.epg;
            // Regra DNA: EPG ID tem que terminar com .BRASIL.
            if (novoEpg && !novoEpg.endsWith('.BRASIL.')) {
                novoEpg = novoEpg.split('.')[0] + ".BRASIL.";
            } else if (!novoEpg) {
                novoEpg = canal.nome.replace(/\s+/g, '') + ".BRASIL.";
            }
            return { ...canal, epg: novoEpg };
        });
        renderizarTabela();
        document.getElementById('statusMsg').innerText = "Protocolo DNA aplicado: IDs ajustados.";
    }

    function atualizarCanal(index, campo, valor) {
        canaisData[index][campo] = valor;
    }

    function removerCanal(index) {
        canaisData.splice(index, 1);
        renderizarTabela();
    }

    function exportarM3U() {
        let m3u = "#EXTM3U\n";
        canaisData.forEach(canal => {
            m3u += `#EXTINF:-1 tvg-id="${canal.epg}" group-title="${canal.grupo}",${canal.nome}\n${canal.url}\n`;
        });
        const blob = new Blob([m3u], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "lista_gemini_tv.m3u";
        a.click();
    }
</script>

</body>
</html>
