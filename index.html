<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini TV - Enterprise v7.3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        cyan: { 450: '#06b6d4' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; overflow: hidden; }
        
        /* UI TWEAKS */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }

        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-header { background: rgba(2, 6, 23, 0.95); border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* DRAG AND DROP STYLES */
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; background: rgba(6, 182, 212, 0.2); }
        .draggable-item.dragging { opacity: 0.5; border: 1px dashed #06b6d4; }

        /* TOAST */
        .toast { animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* MODAL */
        .modal-bg { background-color: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    </style>
</head>
<body>

    <div id="system-layer" class="fixed inset-0 z-50 pointer-events-none flex flex-col items-end p-4">
        <div id="toast-container" class="flex flex-col gap-2 pointer-events-auto"></div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 z-50 modal-bg hidden flex items-center justify-center p-4">
        <div class="glass w-full max-w-md p-6 rounded-xl shadow-2xl border border-white/10 transform scale-100 transition-all">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-2">Título</h3>
            <p id="modal-desc" class="text-gray-400 text-sm mb-4">Descrição</p>
            <div id="modal-content" class="mb-6">
                </div>
            <div class="flex justify-end gap-3">
                <button onclick="Modal.close()" class="px-4 py-2 rounded text-sm font-bold text-gray-400 hover:text-white transition-colors">CANCELAR</button>
                <button id="modal-confirm-btn" class="bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-2 rounded text-sm font-bold shadow-lg transition-transform transform active:scale-95">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <div id="login-screen" class="fixed inset-0 z-40 bg-[#020617] flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-slate-900 border border-slate-800 p-8 rounded-2xl shadow-2xl">
            <div class="text-center mb-8">
                <div class="text-4xl text-cyan-500 mb-2"><i class="fa-solid fa-infinity"></i></div>
                <h1 class="text-2xl font-bold text-white">Gemini TV <span class="text-cyan-500">7.3</span></h1>
                <p class="text-gray-500 text-xs uppercase tracking-widest mt-1">Acesso Seguro</p>
            </div>

            <div class="flex border-b border-slate-800 mb-6">
                <button onclick="Auth.switchTab('login')" id="tab-login" class="flex-1 pb-3 text-sm font-bold text-cyan-500 border-b-2 border-cyan-500">ENTRAR</button>
                <button onclick="Auth.switchTab('register')" id="tab-register" class="flex-1 pb-3 text-sm font-bold text-gray-500 hover:text-gray-300">CRIAR CONTA</button>
            </div>

            <form onsubmit="Auth.submit(event)" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">E-mail</label>
                    <input type="email" id="auth-email" required class="w-full mt-1 bg-slate-950 border border-slate-800 rounded p-3 text-white focus:border-cyan-500 outline-none transition-colors" placeholder="seu@email.com">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Senha</label>
                    <input type="password" id="auth-pass" required minlength="4" class="w-full mt-1 bg-slate-950 border border-slate-800 rounded p-3 text-white focus:border-cyan-500 outline-none transition-colors" placeholder="••••">
                </div>
                <button type="submit" id="auth-btn" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded mt-2 transition-all">ACESSAR SISTEMA</button>
            </form>
            <p id="auth-msg" class="text-center text-xs text-red-400 mt-4 h-4"></p>
        </div>
    </div>

    <div id="app-container" class="hidden h-screen flex flex-col">
        
        <header class="glass-header h-16 flex items-center justify-between px-6 shrink-0 select-none">
            <div class="flex items-center gap-8">
                <div class="font-bold text-lg tracking-tight"><span class="text-cyan-400">GEMINI</span> TV</div>
                
                <nav class="flex gap-1 bg-slate-800/50 p-1 rounded-lg">
                    <button onclick="Router.go('home')" id="nav-home" class="px-4 py-1.5 rounded text-xs font-bold text-white bg-slate-700 shadow transition-all">
                        <i class="fa-solid fa-home mr-1"></i> INÍCIO
                    </button>
                    <button onclick="Router.go('editor')" id="nav-editor" class="px-4 py-1.5 rounded text-xs font-bold text-gray-400 hover:text-white hover:bg-slate-700/50 transition-all">
                        <i class="fa-solid fa-layer-group mr-1"></i> EDITOR
                    </button>
                    <button onclick="Router.go('theater')" id="nav-theater" class="px-4 py-1.5 rounded text-xs font-bold text-gray-400 hover:text-white hover:bg-slate-700/50 transition-all">
                        <i class="fa-solid fa-play mr-1"></i> THEATER
                    </button>
                </nav>
            </div>

            <div class="flex items-center gap-3">
                <button onclick="IO.importDialog()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded text-xs font-bold transition-colors">
                    <i class="fa-solid fa-download mr-1"></i> IMPORTAR
                </button>
                <div class="h-8 w-px bg-white/10 mx-2"></div>
                <div class="text-right hidden md:block">
                    <div class="text-[10px] text-gray-400 uppercase">Logado como</div>
                    <div id="user-display" class="text-xs font-bold text-white">usuario@email.com</div>
                </div>
                <button onclick="Auth.logout()" class="text-gray-400 hover:text-red-500 p-2 transition-colors" title="Sair">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-hidden relative">
            
            <section id="view-home" class="absolute inset-0 p-8 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Minhas Playlists</h2>
                </div>
                
                <div id="playlist-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
                
                <div id="empty-state" class="hidden text-center py-20 opacity-50">
                    <i class="fa-solid fa-ghost text-6xl mb-4 text-gray-600"></i>
                    <p>Nenhuma playlist encontrada.</p>
                </div>
            </section>

            <section id="view-editor" class="absolute inset-0 hidden flex flex-col">
                <div class="h-12 bg-slate-900 border-b border-white/5 flex items-center px-4 justify-between shrink-0">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-gray-500 uppercase">Editando:</span>
                        <select id="editor-pl-select" onchange="Editor.loadPlaylist(this.value)" class="bg-slate-800 text-white text-xs rounded border border-slate-700 px-3 py-1 outline-none focus:border-cyan-500">
                        </select>
                    </div>
                    <div>
                         <button onclick="IO.exportCurrent()" class="text-emerald-400 hover:text-emerald-300 text-xs font-bold px-3 py-1 border border-emerald-500/30 rounded hover:bg-emerald-500/10 transition-colors">
                            <i class="fa-solid fa-file-export mr-1"></i> EXPORTAR M3U
                        </button>
                    </div>
                </div>

                <div class="flex-1 flex overflow-hidden">
                    
                    <div class="w-80 bg-slate-900 border-r border-white/5 flex flex-col">
                        <div class="p-3 border-b border-white/5 bg-slate-800/30">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-xs font-bold text-gray-400 uppercase">GRUPOS <span id="count-groups" class="bg-slate-700 text-white px-1.5 rounded text-[10px] ml-1">0</span></div>
                                <div class="flex gap-1">
                                    <button onclick="Editor.sortGroups()" class="p-1.5 hover:bg-white/10 rounded text-gray-400" title="Ordenar A-Z"><i class="fa-solid fa-arrow-down-a-z text-xs"></i></button>
                                    <button onclick="Editor.toggleAllGroups()" class="p-1.5 hover:bg-white/10 rounded text-gray-400" title="Esconder/Mostrar Todos"><i class="fa-solid fa-eye text-xs"></i></button>
                                </div>
                            </div>
                            <input type="text" id="search-groups" onkeyup="Editor.renderGroups()" placeholder="Filtrar..." class="w-full bg-slate-950 text-white text-xs rounded border border-slate-700 px-3 py-2 outline-none focus:border-cyan-500">
                        </div>
                        <div id="list-groups" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
                    </div>

                    <div class="flex-1 bg-slate-950 flex flex-col">
                        <div class="p-3 border-b border-white/5 bg-slate-900/50 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="text-xs font-bold text-gray-400 uppercase">CANAIS <span id="count-channels" class="bg-cyan-900 text-cyan-200 px-1.5 rounded text-[10px] ml-1">0</span></div>
                                <input type="text" id="search-channels" onkeyup="Editor.renderChannels()" placeholder="Buscar canal..." class="bg-slate-900 text-white text-xs rounded border border-slate-700 px-3 py-1.5 w-64 outline-none focus:border-cyan-500">
                            </div>
                            <div class="flex bg-slate-800 rounded p-0.5">
                                <button class="px-3 py-1 text-[10px] font-bold bg-slate-600 text-white rounded shadow">LISTA</button>
                                <button class="px-3 py-1 text-[10px] font-bold text-gray-500 hover:text-white">LOGOS</button>
                                <button class="px-3 py-1 text-[10px] font-bold text-gray-500 hover:text-white">EPG</button>
                            </div>
                        </div>
                        <div id="list-channels" class="flex-1 overflow-y-auto p-2"></div>
                    </div>
                </div>
            </section>

            <section id="view-theater" class="absolute inset-0 hidden flex bg-black">
                <div class="w-64 bg-slate-900 border-r border-white/10 flex flex-col">
                    <div class="p-3 font-bold text-xs text-cyan-500 border-b border-white/10">SELEÇÃO</div>
                    <div id="theater-list" class="flex-1 overflow-y-auto p-2"></div>
                </div>
                <div class="flex-1 flex items-center justify-center relative group">
                    <video id="video-player" controls class="w-full h-full max-h-screen"></video>
                </div>
            </section>

        </main>
    </div>

    <script>
        // --- UTILITÁRIOS ---
        const Utils = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            toast: (msg, type='success') => {
                const div = document.createElement('div');
                div.className = `toast px-4 py-3 rounded shadow-lg text-sm font-bold flex items-center gap-3 text-white ${type === 'error' ? 'bg-red-900 border-l-4 border-red-500' : 'bg-slate-800 border-l-4 border-cyan-500'}`;
                div.innerHTML = `<i class="fa-solid ${type === 'error' ? 'fa-circle-xmark' : 'fa-check-circle'}"></i> ${msg}`;
                document.getElementById('toast-container').appendChild(div);
                setTimeout(() => div.remove(), 4000);
            }
        };

        // --- SISTEMA DE MODAL (SEM PROMPT FEIO) ---
        const Modal = {
            el: document.getElementById('modal-overlay'),
            title: document.getElementById('modal-title'),
            desc: document.getElementById('modal-desc'),
            content: document.getElementById('modal-content'),
            confirmBtn: document.getElementById('modal-confirm-btn'),
            
            prompt(title, desc, initialValue, callback) {
                this.title.innerText = title;
                this.desc.innerText = desc;
                this.content.innerHTML = `<input type="text" id="modal-input" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white outline-none focus:border-cyan-500" value="${initialValue}">`;
                this.confirmBtn.onclick = () => {
                    const val = document.getElementById('modal-input').value;
                    if(val) callback(val);
                    this.close();
                };
                this.el.classList.remove('hidden');
                setTimeout(() => document.getElementById('modal-input').focus(), 100);
            },
            
            confirm(title, desc, callback) {
                this.title.innerText = title;
                this.desc.innerText = desc;
                this.content.innerHTML = '';
                this.confirmBtn.onclick = () => {
                    callback();
                    this.close();
                };
                this.el.classList.remove('hidden');
            },

            close() { this.el.classList.add('hidden'); }
        };

        // --- AUTH (LOGIN REAL) ---
        const Auth = {
            mode: 'login', // login | register
            user: null,

            init() {
                const session = localStorage.getItem('gtv_session');
                if(session) {
                    this.user = JSON.parse(session);
                    this.enterApp();
                }
            },

            switchTab(mode) {
                this.mode = mode;
                const tabLogin = document.getElementById('tab-login');
                const tabReg = document.getElementById('tab-register');
                const btn = document.getElementById('auth-btn');
                
                if(mode === 'login') {
                    tabLogin.className = "flex-1 pb-3 text-sm font-bold text-cyan-500 border-b-2 border-cyan-500";
                    tabReg.className = "flex-1 pb-3 text-sm font-bold text-gray-500 hover:text-gray-300";
                    btn.innerText = "ACESSAR SISTEMA";
                } else {
                    tabReg.className = "flex-1 pb-3 text-sm font-bold text-cyan-500 border-b-2 border-cyan-500";
                    tabLogin.className = "flex-1 pb-3 text-sm font-bold text-gray-500 hover:text-gray-300";
                    btn.innerText = "CRIAR CONTA";
                }
                document.getElementById('auth-msg').innerText = "";
            },

            submit(e) {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                const msg = document.getElementById('auth-msg');

                // Simulação de Banco de Usuários no LocalStorage
                const usersDB = JSON.parse(localStorage.getItem('gtv_users_db') || '{}');

                if(this.mode === 'register') {
                    if(usersDB[email]) return msg.innerText = "E-mail já cadastrado.";
                    usersDB[email] = pass; // Salva senha (em projeto real, usar hash)
                    localStorage.setItem('gtv_users_db', JSON.stringify(usersDB));
                    Utils.toast("Conta criada! Faça login.");
                    this.switchTab('login');
                } else {
                    if(!usersDB[email] || usersDB[email] !== pass) return msg.innerText = "E-mail ou senha incorretos.";
                    
                    this.user = { email, token: Utils.id() };
                    localStorage.setItem('gtv_session', JSON.stringify(this.user));
                    this.enterApp();
                }
            },

            enterApp() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-display').innerText = this.user.email;
                DB.init();
            },

            logout() {
                localStorage.removeItem('gtv_session');
                location.reload();
            }
        };

        // --- DATABASE (INDEXEDDB) ---
        const DB = {
            db: null,
            async init() {
                const request = indexedDB.open("GeminiTV_v7.3", 1);
                request.onupgradeneeded = e => {
                    const db = e.target.result;
                    if(!db.objectStoreNames.contains('playlists')) db.createObjectStore('playlists', { keyPath: 'id' });
                };
                request.onsuccess = e => {
                    this.db = e.target.result;
                    this.loadAll();
                };
            },
            async save(pl) {
                const tx = this.db.transaction('playlists', 'readwrite');
                tx.objectStore('playlists').put(pl);
                return new Promise(r => tx.oncomplete = r);
            },
            async delete(id) {
                const tx = this.db.transaction('playlists', 'readwrite');
                tx.objectStore('playlists').delete(id);
                return new Promise(r => tx.oncomplete = r);
            },
            async loadAll() {
                const tx = this.db.transaction('playlists', 'readonly');
                const req = tx.objectStore('playlists').getAll();
                req.onsuccess = () => {
                    App.playlists = req.result || [];
                    App.renderHome();
                };
            }
        };

        // --- CORE APP LOGIC ---
        const App = {
            playlists: [],
            currentPL: null,
            currentGroup: null,

            renderHome() {
                const grid = document.getElementById('playlist-grid');
                const empty = document.getElementById('empty-state');
                
                if(this.playlists.length === 0) {
                    grid.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }

                empty.classList.add('hidden');
                // Cards com BOTÕES VISÍVEIS
                grid.innerHTML = this.playlists.map(p => `
                    <div class="glass rounded-xl p-5 flex flex-col hover:border-cyan-500/50 transition-colors group">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-gradient-to-br from-cyan-600 to-blue-700 w-12 h-12 rounded-lg flex items-center justify-center shadow-lg">
                                <i class="fa-solid fa-play text-white text-lg"></i>
                            </div>
                            <div class="text-[10px] bg-slate-800 px-2 py-1 rounded text-gray-400 border border-white/5">M3U</div>
                        </div>
                        <h3 class="font-bold text-white text-lg truncate mb-1">${p.name}</h3>
                        <p class="text-xs text-gray-500 font-mono mb-6">${p.channels.length} canais</p>
                        
                        <div class="mt-auto grid grid-cols-4 gap-2 pt-4 border-t border-white/5">
                            <button onclick="Router.openTheater('${p.id}')" class="bg-slate-800 hover:bg-cyan-600 hover:text-white text-gray-400 py-2 rounded transition-colors" title="Assistir">
                                <i class="fa-solid fa-play"></i>
                            </button>
                            <button onclick="Router.openEditor('${p.id}')" class="bg-slate-800 hover:bg-indigo-600 hover:text-white text-gray-400 py-2 rounded transition-colors" title="Editar">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="IO.exportSingle('${p.id}')" class="bg-slate-800 hover:bg-emerald-600 hover:text-white text-gray-400 py-2 rounded transition-colors" title="Exportar">
                                <i class="fa-solid fa-file-arrow-down"></i>
                            </button>
                            <button onclick="App.deletePlaylist('${p.id}')" class="bg-slate-800 hover:bg-red-600 hover:text-white text-gray-400 py-2 rounded transition-colors" title="Excluir">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            deletePlaylist(id) {
                Modal.confirm("Excluir Playlist", "Tem certeza? Isso não pode ser desfeito.", async () => {
                    await DB.delete(id);
                    App.playlists = App.playlists.filter(p => p.id !== id);
                    App.renderHome();
                    Utils.toast("Playlist removida.");
                });
            }
        };

        // --- ROUTER ---
        const Router = {
            go(view) {
                document.querySelectorAll('main section').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-'+view).classList.remove('hidden');
                
                // Reset Nav styles
                document.querySelectorAll('nav button').forEach(b => {
                    b.classList.remove('text-white', 'bg-slate-700');
                    b.classList.add('text-gray-400');
                });
                document.getElementById('nav-'+view).classList.add('text-white', 'bg-slate-700');
                document.getElementById('nav-'+view).classList.remove('text-gray-400');
            },
            openEditor(id) {
                this.go('editor');
                Editor.init(id);
            },
            openTheater(id) {
                this.go('theater');
                Theater.init(id);
            }
        };

        // --- EDITOR LOGIC (Gourmet) ---
        const Editor = {
            init(id) {
                const sel = document.getElementById('editor-pl-select');
                sel.innerHTML = App.playlists.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                if(id) sel.value = id;
                this.loadPlaylist(sel.value);
            },

            loadPlaylist(id) {
                App.currentPL = App.playlists.find(p => p.id === id);
                if(!App.currentPL) return;
                
                // Extrair grupos se não existirem
                if(!App.currentPL.groups || App.currentPL.groups.length === 0) {
                    const s = new Set(App.currentPL.channels.map(c => c.group));
                    App.currentPL.groups = Array.from(s).sort().map(g => ({ name: g, hidden: false }));
                }

                if(!App.currentGroup && App.currentPL.groups.length > 0) App.currentGroup = App.currentPL.groups[0].name;
                
                this.renderGroups();
                this.renderChannels();
            },

            renderGroups() {
                const list = document.getElementById('list-groups');
                const term = document.getElementById('search-groups').value.toUpperCase();
                
                const filtered = App.currentPL.groups.filter(g => g.name.toUpperCase().includes(term));
                document.getElementById('count-groups').innerText = filtered.length;

                list.innerHTML = filtered.map(g => {
                    const count = App.currentPL.channels.filter(c => c.group === g.name).length;
                    const isActive = App.currentGroup === g.name;
                    
                    return `
                    <div class="group flex items-center justify-between p-2 rounded cursor-pointer border border-transparent hover:border-white/5 hover:bg-white/5 transition-all ${isActive ? 'bg-cyan-500/10 border-cyan-500/50' : ''}" onclick="Editor.selectGroup('${g.name}')">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <i class="fa-solid fa-grip-lines text-gray-600 cursor-grab hover:text-white text-xs"></i>
                            <span class="text-xs font-bold truncate ${isActive ? 'text-cyan-400' : 'text-gray-300'}">${g.name}</span>
                            <span class="text-[10px] text-gray-500 font-mono">(${count})</span>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="Editor.renameGroup(event, '${g.name}')" class="p-1 hover:text-white text-gray-400"><i class="fa-solid fa-pen text-[10px]"></i></button>
                            <button onclick="Editor.toggleGroup(event, '${g.name}')" class="p-1 hover:text-white ${g.hidden ? 'text-red-400' : 'text-gray-400'}"><i class="fa-solid ${g.hidden ? 'fa-eye-slash' : 'fa-eye'} text-[10px]"></i></button>
                        </div>
                    </div>`;
                }).join('');
            },

            selectGroup(name) {
                App.currentGroup = name;
                this.renderGroups(); // Para atualizar o highlight
                this.renderChannels();
            },

            renderChannels() {
                const list = document.getElementById('list-channels');
                if(!App.currentGroup) { list.innerHTML = ''; return; }

                const term = document.getElementById('search-channels').value.toUpperCase();
                const channels = App.currentPL.channels.filter(c => c.group === App.currentGroup && c.name.toUpperCase().includes(term));
                
                document.getElementById('count-channels').innerText = channels.length;

                list.innerHTML = channels.map(c => `
                    <div class="flex items-center gap-3 p-2 border-b border-white/5 hover:bg-white/5 transition-colors draggable-item" draggable="true">
                        <i class="fa-solid fa-grip-vertical text-gray-600 cursor-grab"></i>
                        <img src="${c.logo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMiI+PHJlY3QgeD0iMiIgeT0iNyIgd2lkdGg9IjIwIiBoZWlnaHQ9IjE1IiByeD0iMiIgcnk9IjIiPjwvcmVjdD48cG9seWxpbmUgcG9pbnRzPSIxNyAyIDEyIDcgNyAyIj48L3BvbHlsaW5lPjwvc3ZnPg=='}" class="w-8 h-8 object-contain rounded bg-black/20">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm text-gray-200 truncate font-medium">${c.name}</div>
                            <div class="flex gap-2 text-[10px] text-gray-500 font-mono">
                                <span>ID: ${c.tvgId || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 pr-2">
                             <button onclick="Editor.renameChannel('${c.id}')" class="text-gray-500 hover:text-cyan-400"><i class="fa-solid fa-pen"></i></button>
                             <button onclick="Editor.deleteChannel('${c.id}')" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            },

            // Ações Gourmet (Sem Prompt)
            renameGroup(e, oldName) {
                e.stopPropagation();
                Modal.prompt("Renomear Grupo", "Digite o novo nome:", oldName, (newName) => {
                    if(newName === oldName) return;
                    App.currentPL.channels.forEach(c => { if(c.group === oldName) c.group = newName; });
                    const g = App.currentPL.groups.find(x => x.name === oldName);
                    if(g) g.name = newName;
                    if(App.currentGroup === oldName) App.currentGroup = newName;
                    DB.save(App.currentPL);
                    this.renderGroups();
                    this.renderChannels();
                });
            },

            renameChannel(id) {
                const c = App.currentPL.channels.find(x => x.id === id);
                Modal.prompt("Renomear Canal", "Novo nome:", c.name, (newName) => {
                    c.name = newName;
                    DB.save(App.currentPL);
                    this.renderChannels();
                });
            },
            
            toggleGroup(e, name) {
                e.stopPropagation();
                const g = App.currentPL.groups.find(x => x.name === name);
                g.hidden = !g.hidden;
                // Lógica de ocultar canais seria aplicada na exportação
                DB.save(App.currentPL);
                this.renderGroups();
            },

            deleteChannel(id) {
                if(confirm("Apagar canal?")) { // Usei confirm nativo para velocidade, mas poderia ser Modal
                    App.currentPL.channels = App.currentPL.channels.filter(c => c.id !== id);
                    DB.save(App.currentPL);
                    this.renderChannels();
                }
            }
        };

        // --- IO (IMPORT/EXPORT) ---
        const IO = {
            importDialog() {
                Modal.prompt("Importar Lista M3U", "Cole a URL da sua lista:", "http://", (url) => {
                    this.processURL(url);
                });
            },

            async processURL(url) {
                Utils.toast("Baixando lista...", "info");
                try {
                    const proxy = `https://geminitv-proxy.jcdoni.workers.dev/?url=${encodeURIComponent(url)}`;
                    const res = await fetch(proxy);
                    const text = await res.text();
                    
                    if(!text.includes('#EXTM3U')) throw new Error("Não é uma lista M3U válida.");

                    const lines = text.split('\n');
                    const channels = [];
                    const groupsSet = new Set();

                    for(let i=0; i<lines.length; i++) {
                        if(lines[i].startsWith('#EXTINF:')) {
                            const meta = lines[i];
                            const urlLine = lines[i+1] || "";
                            
                            const name = meta.split(',').slice(1).join(',').trim();
                            const group = (meta.match(/group-title="([^"]+)"/) || ["","GERAL"])[1];
                            const logo = (meta.match(/tvg-logo="([^"]+)"/) || ["",""])[1];
                            const tvgId = (meta.match(/tvg-id="([^"]+)"/) || ["",""])[1];

                            groupsSet.add(group);
                            channels.push({ id: Utils.id(), name, group, logo, tvgId, url: urlLine.trim() });
                        }
                    }

                    const newPL = {
                        id: Utils.id(),
                        name: "Lista Importada " + new Date().toLocaleTimeString(),
                        channels: channels,
                        groups: Array.from(groupsSet).map(g => ({ name: g, hidden: false }))
                    };

                    await DB.save(newPL);
                    await DB.loadAll();
                    Utils.toast(`Sucesso! ${channels.length} canais.`);

                } catch(e) {
                    Utils.toast("Erro: " + e.message, "error");
                }
            },

            exportCurrent() {
                if(!App.currentPL) return;
                this.download(App.currentPL);
            },

            exportSingle(id) {
                const pl = App.playlists.find(p => p.id === id);
                if(pl) this.download(pl);
            },

            download(pl) {
                let m3u = "#EXTM3U\n";
                pl.channels.forEach(c => {
                    const gInfo = pl.groups.find(g => g.name === c.group);
                    if(gInfo && gInfo.hidden) return; // Não exporta grupos ocultos

                    m3u += `#EXTINF:-1 tvg-id="${c.tvgId}" tvg-logo="${c.logo}" group-title="${c.group}",${c.name}\n${c.url}\n`;
                });
                
                const blob = new Blob([m3u], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `GeminiTV_${pl.name}.m3u`;
                document.body.appendChild(link);
                link.click();
                link.remove();
                Utils.toast("Download iniciado.");
            }
        };

        // --- THEATER (HLS PLAYER) ---
        const Theater = {
            hls: null,
            init(id) {
                if(id) {
                    App.currentPL = App.playlists.find(p => p.id === id);
                }
                if(!App.currentPL) return;
                
                const list = document.getElementById('theater-list');
                list.innerHTML = App.currentPL.channels.slice(0, 100).map(c => `
                    <div onclick="Theater.play('${c.url}')" class="p-2 text-xs text-gray-400 hover:text-white hover:bg-white/10 cursor-pointer border-b border-white/5 truncate">
                        ${c.name}
                    </div>
                `).join(''); // Limitado a 100 para demo rápida, ideal seria virtual scroll
            },

            play(url) {
                const video = document.getElementById('video-player');
                if(Hls.isSupported()) {
                    if(this.hls) this.hls.destroy();
                    this.hls = new Hls();
                    this.hls.loadSource(url);
                    this.hls.attachMedia(video);
                    this.hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = url;
                    video.play();
                }
            }
        };

        // Start
        window.onload = () => Auth.init();

    </script>
</body>
</html>
